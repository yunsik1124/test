<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ë‘ë”ì§€ ê²Œì„ â€“ ëª¨ë°”ì¼ ì„¸ë¡œí˜• (ì´ë¯¸ì§€ ìŠ¤í”„ë¼ì´íŠ¸)</title>
  <!-- Pixel font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <!-- âœ… ì´ë¯¸ì§€ í”„ë¦¬ë¡œë“œ -->
  <link rel="preload" as="image" href="images/yellow.png">
  <link rel="preload" as="image" href="images/blue.png">
  <link rel="preload" as="image" href="images/red.png">
  <link rel="preload" as="image" href="images/bomb.png">
  <link rel="preload" as="image" href="images/hp.png">
  <link rel="preload" as="image" href="images/levelup.png">
  <style>
    :root {
      --bg: #0a0c16;
      --panel: #101425;
      --accent: #7c9cff;
      --accent-2: #43d19e;
      --text: #e7eaf6;
      --muted: #96a0c3;
      --gold: #ffd84d;
      --red: #ff5b5b;
      --hole: #0b0f20;
      --px: 4px;
      --tile-dirt: url('https://opengameart.org/sites/default/files/dirt_13.png');
      --tile-grass: url('https://opengameart.org/sites/default/files/grass_47.png');
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent }
    html, body { height: 100% }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans KR", Helvetica, Arial;
      color: var(--text);
      background: #0a0c16;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    /* === [ADD] ìƒë‹¨ ë¡œì»¬ ìµœê³  ê¸°ë¡ í•œ ì¤„ (ë””ìì¸ ìµœì†Œ) === */
    #bestLocal{
      position: fixed; top: 190px; left: 0; right: 0; z-index: 100;
      text-align: center; pointer-events: none;
      font-family: 'Press Start 2P', ui-sans-serif;
      font-size: 10px; line-height: 1;
      color: var(--gold); text-shadow: 0 1px 0 #000;
    }

    /* ê²Œì„ í™”ë©´ */
    .app {
      --pad: 6px;
      --y-offset: -100px; /* í™”ë©´ì„ ìœ„ë¡œ 100px */
      width: 360px;
      height: 360px;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      gap: 0px;
      padding: var(--pad);
      position: relative;
      image-rendering: pixelated;
      transform: translateY(var(--y-offset));
      will-change: transform;
    }

    .panel { background: var(--panel); border-radius: 0; border: var(--px) solid #232a49; box-shadow: 0 0 0 calc(var(--px)) #000 inset; padding: 6px; }

    header h1 { font-family: 'Press Start 2P', ui-sans-serif; font-size: 12px; margin: 0 0 4px 0; text-align: center; letter-spacing: 1px; }

    /* íŠ¸ë¡œí”¼ */
    .trophy { display:flex; align-items:center; justify-content:center; gap:8px; }
    .trophy-icon { font-size: 18px; filter: drop-shadow(0 1px 0 #000); }
    .trophy-track { position: relative; width: 72%; height: 12px; background:#0f1430; border:var(--px) solid #232a49; box-shadow: 0 0 0 calc(var(--px)) #000 inset; }
    .trophy-fill { position:absolute; inset:0; width:0%; background: linear-gradient(90deg, #ffcf33, #ffd84d, #fff2a6); transition: width .2s ease }
    .trophy-label { font-size: 10px; color: var(--muted); text-align:center; margin-top:6px; font-family: 'Press Start 2P', ui-sans-serif; }

    /* ê²Œì´ì§€ */
    .gauge { position: relative; height: 16px; background: #0f1430; border: var(--px) solid #232a49; box-shadow: 0 0 0 calc(var(--px)) #000 inset; }
    .gauge .bar { width: 100%; height: 100%; transform-origin: left center; transform: scaleX(1); transition: transform .12s linear, background .2s linear; background: linear-gradient(90deg, #38d39f, #7c9cff 40%, #ffd84d 70%); }

    /* ë³´ë“œ */
    .board.panel { padding: 6px; background: var(--tile-grass) repeat; background-size: 16px 16px; }
    .boardGrid { width: 100%; aspect-ratio: 1/1; display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr); gap: 6px; }
    .hole { aspect-ratio: 1/1; position: relative; background: var(--tile-dirt) repeat; background-size: 16px 16px; border: var(--px) solid #1a203c; box-shadow: 0 0 0 calc(var(--px)) #000 inset; overflow: hidden; }

    /* ë‘ë”ì§€/ì•„ì´í…œ */
    .mole{
      width: 100%; height: 100%;
      position: absolute; left: 50%; bottom: 0;
      transform: translateX(-50%) translateY(100%);
      opacity: 0;
      transition: transform .3s ease, opacity .5s;
      background-repeat:no-repeat; background-position:center; background-size: 90% 90%;
      image-rendering: pixelated;
    }
    .mole.up { transform: translateX(-50%) translateY(0); opacity: 1; }

    .mole[data-type="yellow"] { background-image:url('images/yellow.png'); }
    .mole[data-type="blue"]   { background-image:url('images/blue.png'); }
    .mole[data-type="red"]    { background-image:url('images/red.png'); }
    .mole[data-type="mine"]   { background-image:url('images/bomb.png'); }
    .mole[data-type="hp"]     { background-image:url('images/hp.png'); }
    .mole[data-type="levelup"]{ background-image:url('images/levelup.png'); }

    .mole .labelText {
      position:absolute; bottom: 8%; left:50%;
      transform: translateX(-50%);
      font-weight:900; font-size: 14px; color:#fff;
      font-family: 'Press Start 2P', ui-sans-serif;
      text-shadow: 0 1px 0 #000;
      pointer-events: none;
    }

    /* ì½¤ë³´ */
    .comboToast { position: fixed; transform: translate(-50%,-20px) scale(.8); color: #fff; font-weight: 900; text-shadow: 0 2px 10px rgba(0,0,0,.5); opacity: 0; pointer-events: none; font-size: 14px; z-index: 60; animation: comboPop .6s ease-out both; font-family: 'Press Start 2P', ui-sans-serif; }
    @keyframes comboPop { 0% { opacity: 0; transform: translate(-50%,-12px) scale(.85) } 30% { opacity: 1; transform: translate(-50%,-26px) scale(1.1) } 70% { opacity: 1 } 100% { opacity: 0; transform: translate(-50%,-42px) scale(1) } }

    /* í”ë“¤ë¦¼ */
    .shake { animation: shake .3s both; }
    @keyframes shake {
      10%,90%{transform: translateY(var(--y-offset)) translate3d(-2px,0,0)}
      20%,80%{transform: translateY(var(--y-offset)) translate3d(4px,0,0)}
      30%,50%,70%{transform: translateY(var(--y-offset)) translate3d(-8px,0,0)}
      40%,60%{transform: translateY(var(--y-offset)) translate3d(8px,0,0)}
    }

    /* ë”¤ë“œ ì˜¤ë²„ë ˆì´ */
    .overlay {
      position: fixed; inset: 0;
      display:grid; place-items:center;
      background: rgba(0,0,0,.65); color:#fff;
      z-index: 70;
    }
    .overlay.hidden { display:none; }
    .count-num { font-size: 40px; font-weight: 900; text-shadow: 0 6px 24px rgba(0,0,0,.6); font-family: 'Press Start 2P', ui-sans-serif; }

    /* ê²½ê³  ì˜¤ë²„ë ˆì´ */
    .warn {
      position: fixed; inset: 0;
      display:grid; place-items:center;
      background: transparent; z-index: 75;
      pointer-events:none
    }
    .warn.hidden { display:none }
    .warn .txt { font-family: 'Press Start 2P', ui-sans-serif; font-size: 28px; color:#ff3333; text-shadow:0 0 8px rgba(255,0,0,.6), 0 2px 0 #000; animation: pulse 0.5s ease-in-out infinite alternate }
    @keyframes pulse { from{ transform: scale(0.98)} to{ transform: scale(1.04)} }

    /* ê²°ê³¼ íŒì—… */
    .modal { position: fixed; inset: 0; display: grid; place-items: center; background: rgba(5,7,15,.55); backdrop-filter: blur(2px); transition: opacity .18s ease; z-index: 80 }
    .modal.hidden { opacity: 0; pointer-events: none }
    .modal-card { width: min(460px, 92vw); display: grid; gap: 10px }
    .summary { display: grid; grid-template-columns: 1fr 1fr; gap: 8px }
    .badge { background: #0e1328; border: var(--px) solid #232a49; box-shadow: 0 0 0 calc(var(--px)) #000 inset; padding: 8px 12px; display: grid; gap: 2px }
    .badge .label { color: var(--muted); font-size: 10px; font-family: 'Press Start 2P', ui-sans-serif; }
    .badge .value { font-variant-numeric: tabular-nums; font-weight: 800; font-family: 'Press Start 2P', ui-sans-serif; }
    .actions { display: grid; grid-auto-flow: column; gap: 8px; justify-content: end }

    .controls.panel { display:flex; gap:6px; align-items:center; justify-content:center }
    .controls select, .controls button, .controls label { font-family: 'Press Start 2P', ui-sans-serif; font-size: 10px }
  </style>
</head>
<body>
  <!-- === [ADD] ìƒë‹¨ ë¡œì»¬ ìµœê³  ê¸°ë¡ === -->
  <div id="bestLocal">
    ìµœê³ ì ìˆ˜: <span id="bestLocalScore">0</span> &nbsp;Â·&nbsp;
    ìµœê³ ëª…ì˜ˆ: <span id="bestLocalHonor">Lv.1 Â· ìƒˆì‹¹ ì—°ìŠµìƒ</span>
  </div>

  <div class="app" id="app">
    <header class="panel">
      <h1>ë‘ë”ì§€ ê²Œì„</h1>
      <div class="trophy">
        <div class="trophy-icon" aria-hidden="true">ğŸ†</div>
        <div class="trophy-track"><div class="trophy-fill" id="trophyFill"></div></div>
      </div>
      <div class="trophy-label" id="trophyLabel">Lv.1 Â· ìƒˆì‹¹ ì—°ìŠµìƒ</div>
    </header>

    <section class="panel">
      <div class="gauge"><div class="bar" id="gaugeBar"></div></div>
    </section>

    <main class="board panel">
      <div id="board" class="boardGrid"></div>
    </main>

    <section class="controls panel">
      <label for="difficulty">ë‚œì´ë„</label>
      <select id="difficulty">
        <option value="easy">ì‰¬ì›€</option>
        <option value="normal" selected>ë³´í†µ</option>
        <option value="hard">ì–´ë ¤ì›€</option>
      </select>
      <button id="start">ì‹œì‘</button>
      <button id="reset" disabled>ë¦¬ì…‹</button>
      <button id="mute">ğŸ”Š</button>
    </section>
  </div>

  <!-- â¬‡ï¸ ì˜¤ë²„ë ˆì´ëŠ” .app ë°–ìœ¼ë¡œ -->
  <div id="countdown" class="overlay hidden"><div class="count-num" id="countNum">3</div></div>
  <div id="warning" class="warn hidden"><div class="txt">WARNING!</div></div>

  <!-- ê²°ê³¼ íŒì—… -->
  <div id="result" class="modal hidden" aria-modal="true" role="dialog" aria-labelledby="resultTitle">
    <div class="modal-card panel">
      <h2 id="resultTitle" style="font-family:'Press Start 2P', ui-sans-serif; font-size:14px; margin:6px 0 0;">ê²°ê³¼</h2>
      <div class="summary">
        <div class="badge"><span class="label">ìµœì¢… ì ìˆ˜</span><span class="value" id="resScore">0</span></div>
        <div class="badge"><span class="label">ëª…ì˜ˆ</span><span class="value" id="resHonor">Lv.1 Â· ìƒˆì‹¹ ì—°ìŠµìƒ</span></div>
      </div>
      <div class="actions">
        <button id="again" class="primary">ë‹¤ì‹œí•˜ê¸°</button>
        <button id="closeRes" class="ghost">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

<script>
  /* âœ… ì´ë¯¸ì§€ ë¯¸ë¦¬ ë¡œë“œ */
  const preloadImgs = [
    "images/yellow.png","images/blue.png","images/red.png",
    "images/bomb.png","images/hp.png","images/levelup.png"
  ];
  preloadImgs.forEach(src => { const img = new Image(); img.src = src; });

  (()=>{

    const app = document.getElementById('app');
    const board = document.getElementById('board');
    const gaugeBar = document.getElementById('gaugeBar');
    const startBtn = document.getElementById('start');
    const resetBtn = document.getElementById('reset');
    const diffSel = document.getElementById('difficulty');
    const muteBtn = document.getElementById('mute');

    const trophyFill = document.getElementById('trophyFill');
    const trophyLabel = document.getElementById('trophyLabel');

    const resModal = document.getElementById('result');
    const resScore = document.getElementById('resScore');
    const resHonor = document.getElementById('resHonor');
    const againBtn = document.getElementById('again');
    const closeResBtn = document.getElementById('closeRes');

    const cd = document.getElementById('countdown');
    const cdNum = document.getElementById('countNum');
    const warn = document.getElementById('warning');

    const HOLES=9, ROWS=3, COLS=3;

    // íƒ€ì…/í¬ì¸íŠ¸/ì‹œê°„ ì„¤ì •
    const typeCfg={yellow:{up:1100},blue:{up:900},red:{up:700},mine:{up:900},hp:{up:900},levelup:{up:1000}};
    const baseGain={yellow:8,blue:11,red:15};
    const typePoints={yellow:1,blue:2,red:3,hp:0,levelup:0};
    const normalTypes=['yellow','blue','blue','red'];

    // === ìƒˆ ë¶„ë¥˜: íŠ¹ìˆ˜ ì•„ì´í…œì€ ë¯¸ìŠ¤ ì‹œ ì½¤ë³´ ìœ ì§€ ===
    const SPECIAL_TYPES = new Set(['mine','hp','levelup']); // ì§€ë¢°/íšŒë³µ/ë ˆë²¨ì—…
    const NORMAL_TYPES  = new Set(['yellow','blue','red']); // ì¼ë°˜ ë‘ë”ì§€

    // ì§€ë¢° ë“±ì¥ í™•ë¥ 
    const MINE_RATE = 0.22;

    // 50ë‹¨ê³„ ëª…ì˜ˆ (ìµœëŒ€ 5000)
    const HONOR_LEVELS = 50;
    function honorThreshold(i){
      if(i<=1) return 0;
      if(i>=HONOR_LEVELS) return 5000;
      const t=(i-1)/(HONOR_LEVELS-1);
      return Math.round(5000*Math.pow(t,1.7));
    }
    const HONOR_NAMES = [
      'ìƒˆì‹¹ ì—°ìŠµìƒ','ì´ˆë³´ ë‹¬ì„±!','ì†œì”¨ê°€ ëŠëŠ” ì¤‘','ì…ë¬¸ í—Œí„°','ì† ë¹ ë¥¸ ì´ˆë³´',
      'ë‘ë”ì§€ ìŠ¤ì¹´ìš°íŠ¸','ìˆ™ë ¨ì','ê³ ìˆ˜ ë“±ê·¹!','ë°˜ì‘ì†ë„ ë‹¬ì¸','ì—°íƒ€ ì¥ì¸',
      'ë‹¬ë¹› í—Œí„°','í™©ê¸ˆ ë§ì¹˜','ì „ì„¤ì˜ ê¸¸ëª©','í­í’ ì†ë†€ë¦¼','ì´ˆê´‘ì† ì‚¬ëƒ¥ê¾¼',
      'ê¶ê·¹ì˜ í—Œí„°','ëª…ì˜ˆì˜ ì „ë‹¹','ë‘ë”ì§€ ë§ˆìŠ¤í„°','ì‹ í™”ì˜ ì‚¬ëƒ¥ê¾¼','ì „ì„¤ ì¬ë¦¼',
      'ì¼ê²© í•„ì‚´','ì½¤ë³´ í­ê²©ìˆ˜','í•´ë¨¸ ì¥êµ°','ì§€í•˜ ì œì™•','êµ´ì°© ëª…ì¸',
      'ë©”íŠ¸ë¡œ ë†€ë¼ì›€','ì„¬ê´‘ ë°˜ì‚¬ ì‹ ê²½','ê·¸ëœë“œ í—Œí„°','ìŠˆí¼ ë…¸í•˜ìš°','ê¸ˆë¹› ë²ˆê°œ',
      'ì´ˆì›”ì˜ ì†ë†€ë¦¼','ë³„ì˜ ì‚¬ëƒ¥ê¾¼','ê¶ê·¹ ë°˜ì‘ì™•','ê·¹ì˜ å¢ƒåœ°','ë„ì‚¬ ê²½ì§€',
      'ì´ˆì‹ ì† í—Œí„°','í­í’ ë§ˆìŠ¤í„°','ì˜ì›…ì˜ ê·€í™˜','ë¬´ìŒì˜ ì „ì„¤','ì ˆëŒ€ì',
      'ì²œìƒê³„ ì…ë¬¸','ì„±ì¢Œì˜ ìˆ˜í˜¸ì','ëíŒ ëŒ€ì¥','ìš°ì£¼ì  ì†ë„','ì°¨ì›ì˜ íŒŒìˆ˜ê¾¼',
      'ì‹ ì„±ì˜ ì±„ì°','ì˜ê²ì˜ í—Œí„°','ì°½ì„¸ê¸°ì˜ ë§ì¹˜','ìš°ì£¼ì˜ ì§€ë°°ì','ë‘ë”ì§€ê³„ì˜ ì‹ !'
    ];

    function getHonor(score){
      let level=1;
      for(let i=HONOR_LEVELS;i>=1;i--){
        if(score>=honorThreshold(i)){ level=i; break; }
      }
      const name=HONOR_NAMES[level-1]||HONOR_NAMES[HONOR_NAMES.length-1];
      const prev=honorThreshold(level);
      const next=honorThreshold(Math.min(level+1,HONOR_LEVELS));
      const progress= level>=HONOR_LEVELS?1:Math.max(0,Math.min(1,(score-prev)/Math.max(1,next-prev)));
      return {level,name,progress, prev, next};
    }

    // ë‚œì´ë„ ìŠ¤ì¼€ì¼ë§
    function paramsFromLevel(level){
      const s = (level-1)/(HONOR_LEVELS-1); // 0..1
      const maxActive =
        (s < 0.20) ? 1 :
        (s < 0.45) ? 2 :
        (s < 0.70) ? 3 :
        (s < 0.90) ? 4 : 5;
      return {
        drainMult: 1 + 1.0*s,
        gainMultHonor: Math.max(0.35, 1 - 0.6*s),
        spawnInterval: 825 - 750*s,
        maxActive
      };
    }

    // ===== ìƒíƒœ =====
    let isPlaying=false, isCounting=false, score=0, gauge=100, combo=0, maxCombo=0, lastHit=0, lastActionAt=0;
    let active=new Set();
    let upMap=new Map(); // idx -> {to, type, missed}
    let tickTimer=null, spawnTimeout=null, countdownTimer=null;
    let muted=false, audioCtx=null;
    let prevLevel=1, boostUntilLevel=0;

    // íŠ¹ìˆ˜ íƒ€ì…(1~5ë ˆë²¨ êµ¬ê°„ ë‚´ 1íšŒ ë“±ì¥) í”Œë˜ê·¸: HPëŠ” ì œì™¸, LEVELUPë§Œ ìœ ì§€
    let spawnedLv=false;

    // ===== Audio (í•©ì„±) =====
    function createCtx(){ if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)(); }
    function ping(f=600,d=0.06,t='sine',v=0.3){
      if(muted)return; createCtx();
      const now=audioCtx.currentTime;
      const o=audioCtx.createOscillator(); const g=audioCtx.createGain();
      o.type=t; o.frequency.setValueAtTime(f,now);
      g.gain.setValueAtTime(0.0001,now);
      g.gain.exponentialRampToValueAtTime(v,now+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001,now+d);
      o.connect(g).connect(audioCtx.destination); o.start(now); o.stop(now+d+0.02);
    }
    function hitChime(){ if(muted)return; createCtx(); [660,880,990].forEach((f,i)=> setTimeout(()=> ping(f,0.06,i===2?'triangle':'sine',0.28), i*42)); }
    function buzzStrong(){ if(muted)return; createCtx(); [90,70,50].forEach((f,i)=> setTimeout(()=> ping(f,0.16,'sawtooth',0.6), i*90)); }
    function mineBlast(){ if(muted)return; createCtx(); [150,100,60,40].forEach((f,i)=> setTimeout(()=> ping(f,0.18,'square',0.7), i*80)); }

    // ì¹´ìš´íŠ¸ë‹¤ìš´ íš¨ê³¼ìŒ
    function countdownBeep(n){ if(muted) return; const freq=[0,520,600,720][n]||520; ping(freq,0.10,'sine',0.35); }
    function countdownStart(){ if(muted) return; [880,1040,1240].forEach((f,i)=> setTimeout(()=> ping(f,0.08,'triangle',0.4), i*60)); }

    // BGM (ë£¨í”„)
    let bgmTimer=null;
    function startBgm(){ if(muted) return; createCtx(); stopBgm();
      const pattern=[440,554,659,554,440,440,554,659,740,659,554,494]; let i=0;
      bgmTimer=setInterval(()=>{ ping(pattern[i%pattern.length],0.14,'triangle',0.22); i++; },180);
    }
    function stopBgm(){ if(bgmTimer){ clearInterval(bgmTimer); bgmTimer=null; } }

    // ì—”ë”©: ëª…ì˜ˆì— ë”°ë¥¸ êµ°ì¤‘ ì‚¬ìš´ë“œ
    function noiseBurst(dur=0.15, vol=0.35){ if(muted)return; createCtx();
      const sr=audioCtx.sampleRate; const len=Math.floor(sr*dur);
      const buf=audioCtx.createBuffer(1,len,sr); const data=buf.getChannelData(0);
      for(let i=0;i<len;i++){ data[i]=(Math.random()*2-1)*Math.pow(1-i/len,2); }
      const src=audioCtx.createBufferSource(); const g=audioCtx.createGain(); g.gain.value=vol;
      src.buffer=buf; src.connect(g).connect(audioCtx.destination); src.start();
    }
    function playCrowd(level){
      if(muted)return;
      if(level<10){ [180,140,100].forEach((f,i)=> setTimeout(()=> ping(f,0.25,'sawtooth',0.6), i*160)); setTimeout(()=> noiseBurst(0.25,0.4), 60); }
      else if(level<30){ for(let i=0;i<12;i++){ setTimeout(()=> noiseBurst(0.08,0.32), 60*i); } }
      else { [660,880,990,1320].forEach((f,i)=> setTimeout(()=> ping(f,0.10,'triangle',0.45), i*70)); for(let i=0;i<20;i++){ setTimeout(()=> noiseBurst(0.08,0.35), 40*i); } }
    }

    function updateTrophy(){
      const h=getHonor(score);
      trophyFill.style.width=`${Math.round(h.progress*100)}%`;
      trophyLabel.textContent=`Lv.${h.level} Â· ${h.name}`;
    }

    function updateGaugeColor(){
      if(gauge<50){
        const t=1-(gauge/50); const light=56-28*t;
        gaugeBar.style.background=`hsl(0 100% ${light}%)`;
      } else { gaugeBar.style.background=''; }
    }

    function setGauge(v){
      gauge=Math.max(0,Math.min(100,v));
      gaugeBar.style.transform=`scaleX(${gauge/100})`;
      updateGaugeColor();
      if(gauge<=0) endGame();
    }

    // ===== ë³´ë“œ êµ¬ì„± =====
    const holes=[];
    for(let i=0;i<HOLES;i++){
      const hole=document.createElement('div'); hole.className='hole';
      const mole=document.createElement('div'); mole.className='mole'; mole.dataset.idx=i;
      hole.appendChild(mole); board.appendChild(hole);
      holes.push(hole);
    }

    const idxToRC = (i)=>({ r: Math.floor(i/COLS), c: i%COLS });
    function isAdjacentToActive(idx){
      const {r,c}=idxToRC(idx);
      for(const a of active){ const {r:ar,c:ac}=idxToRC(a); if(Math.abs(r-ar)<=1 && Math.abs(c-ac)<=1) return true; }
      return false;
    }

    // â¬‡ï¸ HP í™•ë¥ : ê²Œì´ì§€ë§Œ ë³¸ë‹¤
    function hpChanceByGauge(g){
      if(g > 50) return 0.0;   // 50% ì´ˆê³¼ â†’ 0%
      if(g > 20) return 0.20;  // 20~50% â†’ 10%
      return 0.80;             // 20% ì´í•˜ â†’ 30%
    }

    function spawnOne(){
      if(!isPlaying) return;
      const free=[]; for(let i=0;i<HOLES;i++) if(!active.has(i)) free.push(i);
      if(!free.length) return;

      let candidates=free.filter(i=>!isAdjacentToActive(i)); if(!candidates.length) candidates=free;
      const idx=candidates[Math.floor(Math.random()*candidates.length)];
      const mole=holes[idx].firstChild;

      const h=getHonor(score).level;

      // â”€â”€ íƒ€ì… ì„ íƒ ì‹œì‘ â”€â”€
      let tkey=null;

      // (A) HP: ê³µí†µ íŠ¹ìˆ˜ ê·œì¹™ ì™„ì „ ì œì™¸, ê²Œì´ì§€ í™•ë¥ ë§Œ
      const hpChance = hpChanceByGauge(gauge);
      if(Math.random() < hpChance){
        tkey = 'hp';
      }

      // (B) ì•„ì§ ë¯¸ì •ì´ë©´ ë ˆë²¨ì—…(ë ˆë²¨ 1~5ì—ì„œ 1íšŒ ë“±ì¥)
      if(!tkey && h <= 5 && !spawnedLv && Math.random() < 0.05){
        tkey = 'levelup';
        spawnedLv = true;
      }

      // (C) ì•„ì§ ë¯¸ì •ì´ë©´ ì§€ë¢°/ì¼ë°˜
      if(!tkey){
        const isMine=Math.random()<MINE_RATE;
        tkey=isMine?'mine':normalTypes[Math.floor(Math.random()*normalTypes.length)];
      }
      // â”€â”€ íƒ€ì… ì„ íƒ ë â”€â”€

      active.add(idx); mole.dataset.type=tkey; mole.classList.add('up');

      // ë¼ë²¨ í…ìŠ¤íŠ¸
      let tag=mole.querySelector('.labelText');
      if(!tag){ tag=document.createElement('div'); tag.className='labelText'; mole.appendChild(tag); }
      tag.textContent = (tkey==='mine' ? 'ì§€ë¢°' : tkey==='hp' ? 'HP' : tkey==='levelup' ? 'LEVEL UP!' : '');

      const to=setTimeout(()=> hide(idx, true), typeCfg[tkey].up);
      upMap.set(idx,{to, type:tkey, missed:true});
    }

    function spawnLoop(){
      if(!isPlaying) return;
      const {level}=getHonor(score);
      const p=paramsFromLevel(level);
      let maxActive=p.maxActive;
      let interval=Math.max(120, Math.floor(p.spawnInterval));
      if(level < boostUntilLevel){ interval = Math.max(80, Math.floor(interval/3)); maxActive = Math.min(6, maxActive+1); }
      const need=Math.max(0, maxActive - active.size);
      for(let n=0;n<need;n++) spawnOne();
      spawnTimeout=setTimeout(spawnLoop, interval);
    }

    // ì™„ì „íˆ ë‚´ë ¤ê°„ ë’¤ì—ë§Œ miss() ì²˜ë¦¬(ì¼ë°˜ë§Œ), íŠ¹ìˆ˜ëŠ” lastHit ë¦¬í”„ë ˆì‹œë¡œ ì½¤ë³´ ìœ ì§€
    function hide(idx, auto=false){
      const mole=holes[idx].firstChild;
      const entry=upMap.get(idx);
      if(entry){ clearTimeout(entry.to); }
      mole.classList.remove('up');   // ë‚´ë ¤ê°€ê¸° ì‹œì‘
      active.delete(idx);

      const label=mole.querySelector('.labelText'); if(label) label.remove();

      if (auto && entry && entry.missed) {
        if (NORMAL_TYPES.has(entry.type)) {
          // ì¼ë°˜ ë‘ë”ì§€ ìë™ ë¯¸ìŠ¤ â†’ ì½¤ë³´ ëŠê¹€
          const onEnd = () => {
            mole.removeEventListener('transitionend', onEnd);
            miss();
            if (entry) upMap.delete(idx);
          };
          mole.addEventListener('transitionend', onEnd, { once: true });
        } else if (SPECIAL_TYPES.has(entry.type)) {
          // íŠ¹ìˆ˜ ì•„ì´í…œ ìë™ í‡´ì¥ â†’ ì½¤ë³´ ìœ ì§€: íƒ€ì´ë¨¸ë§Œ ê°±ì‹ 
          const onEnd = () => {
            mole.removeEventListener('transitionend', onEnd);
            lastHit = performance.now(); // ğŸ‘ˆ ì½¤ë³´ íƒ€ì´ë¨¸ ë¦¬í”„ë ˆì‹œ
            if (entry) upMap.delete(idx);
          };
          mole.addEventListener('transitionend', onEnd, { once: true });
        } else {
          if (entry) upMap.delete(idx);
        }
      } else {
        if (entry) upMap.delete(idx);
      }
    }

    // ===== ì½¤ë³´ ì ìˆ˜ ê°€ì¤‘ì¹˜ =====
    function comboScoreFactor(c){
      const step=0.15, cap=2.0;
      return Math.min(1 + Math.max(0,c-1)*step, cap);
    }

    // ===== í† ìŠ¤íŠ¸/ì´í™íŠ¸ =====
    function showComboToast(mole,combo){
      if(combo<2)return;
      const r=mole.getBoundingClientRect();
      const div=document.createElement('div');
      div.className='comboToast'; div.textContent=`x${combo} COMBO!`;
      div.style.left=(r.left+r.width/2)+'px'; div.style.top=(r.top)+'px';
      document.body.appendChild(div); setTimeout(()=>div.remove(),620);
    }

    function showLevelUpText(){
      const rect=trophyLabel.getBoundingClientRect();
      const el=document.createElement('div');
      el.textContent='LEVEL UP!';
      el.style.position='fixed';
      el.style.left=(rect.left+rect.width/2)+'px';
      el.style.top=(rect.top-10)+'px';
      el.style.transform='translate(-50%,0)';
      el.style.fontFamily="'Press Start 2P', ui-sans-serif";
      el.style.fontSize='16px';
      el.style.color='#ffd84d';
      el.style.textShadow='0 2px 0 #000, 0 0 8px rgba(255,216,77,.7)';
      el.style.transition='transform .6s ease, opacity .6s ease';
      el.style.zIndex=120;
      document.body.appendChild(el);
      requestAnimationFrame(()=>{ el.style.transform='translate(-50%,-22px)'; el.style.opacity='0'; });
      setTimeout(()=> el.remove(), 700);
    }

    function animateFly(mole,target){ // target: 'gauge' | 'trophy'
      const r=mole.getBoundingClientRect();
      const ghost=mole.cloneNode(true);
      ghost.style.position='fixed';
      ghost.style.left=r.left+'px';
      ghost.style.top=r.top+'px';
      ghost.style.width=r.width+'px';
      ghost.style.height=r.height+'px';
      ghost.style.transition='all .6s ease';
      ghost.style.zIndex=200;
      document.body.appendChild(ghost);

      const dest = (target==='gauge') ? gaugeBar.getBoundingClientRect() : trophyFill.getBoundingClientRect();

      requestAnimationFrame(()=>{
        ghost.style.left=dest.left+'px';
        ghost.style.top=dest.top+'px';
        ghost.style.opacity='0';
        ghost.style.transform='scale(.4)';
      });

      setTimeout(()=> ghost.remove(), 620);
    }

    function afterLevelCheck(){
      const h=getHonor(score);
      if(h.level>prevLevel){
        for(let lv=prevLevel+1; lv<=h.level; lv++){
          if(lv%5===0){ triggerWarning(lv); }
        }
        prevLevel=h.level;
      }
      updateTrophy();
    }

    function bumpOneLevel(){
      const h=getHonor(score);
      const nextLv=Math.min(h.level+1, HONOR_LEVELS);
      const need=honorThreshold(nextLv);
      if(score < need) score = need;
      afterLevelCheck();
    }

    // ===== íŒì •/íš¨ê³¼ =====
    function hitNormal(idx,mole){
      const now=performance.now();
      const d={comboWindow:1400, comboStep:0.10, gainMult:1};
      if(now-lastHit<=d.comboWindow) combo++; else combo=1;
      lastHit=now; lastActionAt=now; maxCombo=Math.max(maxCombo,combo);

      const tkey=mole.dataset.type;
      const honor=paramsFromLevel(getHonor(score).level);

      // ê²Œì´ì§€ íšŒë³µ
      const gain=baseGain[tkey]*d.gainMult*honor.gainMultHonor*(1+Math.max(0,combo-1)*d.comboStep);
      setGauge(gauge+gain);

      // ì ìˆ˜
      const ptsBase=typePoints[tkey];
      const pts = Math.round(ptsBase * comboScoreFactor(combo));
      score+=pts;

      const entry=upMap.get(idx); if(entry) entry.missed=false;
      afterLevelCheck();

      hitChime(); showComboToast(mole,combo); hide(idx);
    }

    function hitMine(idx,mole){
      const now=performance.now(); lastActionAt=now; combo=0;
      setGauge(gauge-35);
      const entry=upMap.get(idx); if(entry) entry.missed=false;
      app.classList.add('shake'); setTimeout(()=> app.classList.remove('shake'), 300);
      mineBlast(); hide(idx);
    }

    function hitHp(idx,mole){
      const now=performance.now(); lastActionAt=now;
      if(now-lastHit<=1400) combo++; else combo=1; lastHit=now; maxCombo=Math.max(maxCombo,combo);
      setGauge(gauge+50); // 50% íšŒë³µ
      const entry=upMap.get(idx); if(entry) entry.missed=false;
      hitChime(); showComboToast(mole,combo);
      animateFly(mole,'gauge');
      hide(idx);
    }

    function hitLevelup(idx,mole){
      const now=performance.now(); lastActionAt=now;
      if(now-lastHit<=1400) combo++; else combo=1; lastHit=now; maxCombo=Math.max(maxCombo,combo);
      const entry=upMap.get(idx); if(entry) entry.missed=false;
      hitChime(); showComboToast(mole,combo);
      animateFly(mole,'trophy');
      bumpOneLevel(); // ë ˆë²¨ 1 ìƒìŠ¹
      showLevelUpText();
      hide(idx);
    }

    function miss(){
      const now=performance.now(); lastActionAt=now;
      setGauge(gauge-22); combo=0;
      app.classList.add('shake'); setTimeout(()=> app.classList.remove('shake'), 300);
      buzzStrong();
    }

    // hole ì „ì²´ í´ë¦­ í—ˆìš©
    board.addEventListener('pointerdown',e=>{
      if(!isPlaying)return;
      const hole=e.target.closest('.hole'); if(!hole) return;
      const mole=hole.firstChild;
      if(mole&&mole.classList.contains('up')){
        const idx=Number(mole.dataset.idx);
        const t=mole.dataset.type;
        if(t==='mine')         hitMine(idx,mole);
        else if(t==='hp')      hitHp(idx,mole);
        else if(t==='levelup') hitLevelup(idx,mole);
        else                   hitNormal(idx,mole);
      } else miss();
    });

    // ===== ì¹´ìš´íŠ¸ë‹¤ìš´ & í”Œë¡œìš° =====
    function beginCountdown(cb){
      if(isCounting) return;
      isCounting=true; cd.classList.remove('hidden');
      let n=3; cdNum.textContent=String(n); countdownBeep(n);
      if(countdownTimer) { clearInterval(countdownTimer); countdownTimer=null; }
      countdownTimer=setInterval(()=>{
        n--;
        if(n>0){ cdNum.textContent=String(n); countdownBeep(n); }
        else {
          cdNum.textContent='START!'; countdownStart();
          setTimeout(()=>{
            cd.classList.add('hidden'); isCounting=false; cb();
          }, 350);
          clearInterval(countdownTimer); countdownTimer=null;
        }
      }, 1000);
    }

    function triggerWarning(level){
      warn.classList.remove('hidden');
      setTimeout(()=> warn.classList.add('hidden'), 2000);
      boostUntilLevel = level + 1;        // í˜„ì¬ ë ˆë²¨ì—ì„œë§Œ ìœ íš¨
      if(!muted){ try{ new Audio('sound/buzzer.wav').play(); }catch(e){} }
    }

    function realStart(){
      isPlaying=true; score=0; combo=0; maxCombo=0; gauge=100;
      prevLevel=getHonor(score).level; boostUntilLevel=0;

      // ë ˆë²¨ì—… ìŠ¤í° ë¦¬ì…‹ (HPëŠ” ë¦¬ì…‹ ê°œë… ì—†ìŒ)
      spawnedLv=false;

      updateTrophy(); updateGaugeColor(); startBgm(); lastActionAt=performance.now();

      const dt=0.1;
      if(tickTimer){ clearInterval(tickTimer); }
      tickTimer=setInterval(()=>{
        const now=performance.now();
        const honor=paramsFromLevel(getHonor(score).level);
        let drain=8; if(active.size===0) drain=14; else if(now-lastActionAt>2500) drain=10;
        drain*=honor.drainMult;
        setGauge(gauge - drain*dt);
      }, dt*1000);

      // ì‹œì‘ ì§í›„ í•œ ë§ˆë¦¬ ì¦‰ì‹œ
      spawnOne();
      spawnLoop();

      startBtn.disabled=true; diffSel.disabled=true;
      resetBtn.disabled=false;
    }

    function start(){
      if(isPlaying||isCounting) return;
      resetBtn.disabled=false;
      beginCountdown(realStart);
    }

    // í™”ë©´ì˜ ëª¨ë“  ë‘ë”ì§€ ì œê±°
    function clearAllMoles(){
      document.querySelectorAll('.mole').forEach(m=>{
        m.classList.remove('up');
        const t=m.querySelector('.labelText'); if(t) t.remove();
      });
      active.clear();
      upMap.forEach(e=>{ try{ clearTimeout(e.to); }catch(_){} });
      upMap.clear();
    }

    function endGame(){
      if(!isPlaying) return;
      isPlaying=false;
      if(tickTimer){ clearInterval(tickTimer); tickTimer=null; }
      if(spawnTimeout){ clearTimeout(spawnTimeout); spawnTimeout=null; }
      clearAllMoles();
      stopBgm(); showResult();
    }

    function hardClearTimers(){
      if(countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; }
      if(tickTimer){ clearInterval(tickTimer); tickTimer=null; }
      if(spawnTimeout){ clearTimeout(spawnTimeout); spawnTimeout=null; }
      upMap.forEach(e=>clearTimeout(e.to)); upMap.clear();
    }

    function reset(){
      hardClearTimers();
      if(isCounting){ cd.classList.add('hidden'); isCounting=false; }
      if(isPlaying){ stopBgm(); }
      isPlaying=false;
      clearAllMoles();

      gauge=100; score=0; combo=0; maxCombo=0; prevLevel=1; boostUntilLevel=0;

      // ë ˆë²¨ì—… ë¦¬ì…‹ë§Œ ìœ ì§€ (HP ì—†ìŒ)
      spawnedLv=false;

      updateTrophy(); updateGaugeColor();
      startBtn.disabled=false; diffSel.disabled=false;
      resetBtn.disabled=false;
    }

    /* ==== ê²°ê³¼ íŒì—… ==== */
    function showResult(){
      const h=getHonor(score);
      resScore.textContent=String(score);
      resHonor.textContent=`Lv.${h.level} Â· ${h.name}`;
      resModal.classList.remove('hidden');
      playCrowd(h.level);
      if(!muted){ try{ new Audio('sound/fail.wav').play(); }catch(e){} }

      /* === [ADD] ë¡œì»¬ ìµœê³  ê¸°ë¡ ê°±ì‹  === */
      const bestScoreKey = 'bestScore';
      const bestHonorLevelKey = 'bestHonorLevel';
      const bestHonorNameKey  = 'bestHonorName';

      const prevBestScore = parseInt(localStorage.getItem(bestScoreKey) || '0', 10) || 0;
      const prevBestHonorLv = parseInt(localStorage.getItem(bestHonorLevelKey) || '1', 10) || 1;

      // ì ìˆ˜ ìµœê³  ê°±ì‹ 
      if (score > prevBestScore) {
        localStorage.setItem(bestScoreKey, String(score));
      }
      // ëª…ì˜ˆ ìµœê³  ê°±ì‹ (ë ˆë²¨ ìš°ì„  ë¹„êµ)
      if (h.level > prevBestHonorLv) {
        localStorage.setItem(bestHonorLevelKey, String(h.level));
        localStorage.setItem(bestHonorNameKey, h.name);
      } else if (h.level === prevBestHonorLv) {
        // ë ˆë²¨ ê°™ì„ ë•Œ ì ìˆ˜ë¡œ íƒ€ì´ë¸Œë ˆì´í¬
        if (score > prevBestScore) {
          localStorage.setItem(bestHonorLevelKey, String(h.level));
          localStorage.setItem(bestHonorNameKey, h.name);
        }
      }
      renderBestLocal();
    }
    function hideResult(){ resModal.classList.add('hidden'); }

    /* ===== ìƒë‹¨ ë¡œì»¬ ìµœê³  ê¸°ë¡ í‘œì‹œ ===== */
    const bestLocalScoreEl = document.getElementById('bestLocalScore');
    const bestLocalHonorEl = document.getElementById('bestLocalHonor');
    function renderBestLocal(){
      const bestScore = parseInt(localStorage.getItem('bestScore') || '0', 10) || 0;
      const bestHonorLv = parseInt(localStorage.getItem('bestHonorLevel') || '1', 10) || 1;
      const bestHonorName = localStorage.getItem('bestHonorName') || 'ìƒˆì‹¹ ì—°ìŠµìƒ';
      bestLocalScoreEl.textContent = String(bestScore);
      bestLocalHonorEl.textContent = `Lv.${bestHonorLv} Â· ${bestHonorName}`;
    }
    renderBestLocal(); // ì´ˆê¸° 1íšŒ

    /* ==== ì´ë²¤íŠ¸ ë°”ì¸ë”© ==== */
    startBtn.addEventListener('click', start);
    resetBtn.addEventListener('click', reset);
    againBtn?.addEventListener('click', ()=>{ hideResult(); start(); });
    closeResBtn?.addEventListener('click', hideResult);
    muteBtn.addEventListener('click',()=>{
      const m=(window._muted=!window._muted);
      muted=m; muteBtn.textContent=m?'ğŸ”‡':'ğŸ”Š';
      if(m) stopBgm(); else if(isPlaying) startBgm();
    });
  })();
</script>
</body>
</html>
